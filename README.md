# Cassandra:A-Decentralized-Structured-Storage-System

## 摘要

Cassandra 是一个分散式存储系统，用于处理数量庞大的并且分散在许多普通服务器上的结构化数据，同时它也提供了没有单点故障的高可用性服务。Cassandra旨在运行在成百上千的节点的基础设施上（可能分散在不同的数据中心）。在这个规模级别，大大小小的组件不断出现故障。面对这些故障，Cassandra管理持久化状态的方式驱动了整个系统的可靠性和可用性。尽管在许多方面Cassandra类似一个数据库而且和数据库有很多相同的设计和实现策略，但它仍不支持完全关系数据模型；它提供了带有简单数据模型的客户端，支持对数据表层和格式的动态控制。Cassandra系统被设计用来运行在普通的硬件上，并且能够处理高速写入同时不牺牲读取性能。

## 1. 介绍

Facebook巨大的社交网络平台在峰值的时候靠着数以千计的散落在世界各地不同数据中心的服务器服务着上百万的用户。这些需求对Facebook的平台有着极高的要求。处理这些由成百上千组件构成的平台产生的故障是很正常的，因为总会有一些组件在某个时候就挂了。因此，软件系统需要构建一种机制，这种机制把故障看成一种正常现象而不是异常。为了达到以上所描述的可靠性和可扩展性，Facebook开发了Cassandra。

Cassandra使用了许多广为人知的技术来达到可用性和可扩展性。Cassandra被设计用来满足收件箱搜索问题的存储需求。在Facebook那意味着系统要处理大量的写请求，同时还有大量的用户。Cassandra自从2008年上线以来，到今天它所承载的用户量已经从100百万达到了250百万，达到了我们的预期。

## 2. 相关工作

分布式数据对性能、可用性和耐久性的作用在对文件系统和数据的研究中就已经深入学习过了。和P2P存储系统仅支持平级命名空间不同，分布式文件系统支持层级的命名空间。像Ficus和Coda到处复制文件以保证高可用性的同时牺牲了一致性。Farsite是一种不使用任何集中服务器的分布式文件系统。Farsite使用复制来达到高可用性和可扩展性。GFS（谷歌文件系统）是另一种分布式文件系统。GFS使用一种简单的设计方案，一个主节点服务器用来保持整个系统的元数据，数据被分割灌进chunks并存在chunk服务器上。然而GFS的主节点现在用Chubby来处理容错问题。Bayou是一个分布式关系数据库系统，它允许离线操作并且提供最终数据一致性。在以上这些系统中，Bayou,Coda和Ficus允许离线操作并且对一些像network partitions和outages这样的问题是弹性的。这些系统对冲突解决过程都有各自的不同点。然而所有这些系统都保证了最终一致性。与这些系统相似，Dynamo也支持读写操作，甚至是在network partitions过程中和利用不同的冲突解决机制解决更新冲突的过程中。虽然健壮的一致性给应用程序员提供了方便的编程模型，但是这些系统在可用性和可扩展性上还有很大局限。这些系统不能处理network partitions，因为它们只提供了健壮的一致性保障。

Dynamo是一个存储系统，亚马逊用它来存储和获取用户购物数据。Dynamo基于隶属度算法（membership algorithm）的Gossip帮助每个节点维持每个其他节点的信息。

## 3. 数据模型

Cassandra中的表是一个分布式的以key索引的多维度的map。value是一个高结构化的对象。表中的row key是一个没有大小限制的字符串，但是通常是16到36字节。每一个row key下的操作都是原子的。columns被组织在一起放进sets，称作列簇，和Bigtable中的概念非常相似。Cassandra中有两种列簇，simple和super两种，super column family 可以被视为一个列簇中的列簇。

应用可以给columns排序。系统允许columns按时间或名字排序。上面讲到的收件箱搜索就是按时间排序的。虽然系统支持多表的概念，但是所有的部署实际上在他们的schema里只有一个表。

## 4. API

Cassandra的API由以下三个简单的方法组成。

- insert(table, key, rowMutaion)
- get(table, key, columnName)
- delete(table, key, columnName) 


## 5. 系统架构

需要在设计生产设置中操作的存储系统的架构是非常复杂的。除了实际的数据持久化组件以外，系统还需要有以下几个特性：可扩展，负载均衡问题的健壮的解决方案，membership和故障检测，故障恢复，复制同步，过载处理，状态转换，并发和job分配，请求编组，请求路径，系统检测和预警，配置管理。我们在这边文章中只关注Cassandra中用到的核心的分布式系统技术：partitioning,replication，membership,failure handling and scaling。所有这些模块同步工作来锤炼读写请求。对于写数据来说，系统发送请求给复制节点同时等待着复制节点返回的数据来确定写操作是否完成。对读数据来说，基于客户端需要的一致性保障，系统也会发送请求给最近的复制节点或者发送请求给所有的复制节点同时等待着它们的回复。

### 5.1 Partitioning

Cassandra的关键特性之一就是它的可扩展能力。这需要动态的分配数据到集群中各个节点上的能力。Cassandra使用consistent hashing在集群中分配数据，同时使用一种规则来保持哈希函数。在consistent hashing中，哈希函数的输出范围被看作是一个固定的环。系统中的每个节点被分配给一个随机的值，这个值代表它在环中的位置。每个被key唯一标识的数据项被分配到一个节点，通过哈希函数计算数据项的key从而把它映射到环中某个位置，然后沿着环顺时针走找到第一个其位置比item的位置大的节点。这个节点被认为是这个key的coordinator。应用指定这个key，Cassandra使用它给某个路径发送请求。consistent hashing的主要的优点在于背离或者前往某个节点只会影响它的直接邻居而不会牵连到其他节点。

